<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©ç®¡ç†ç³»ç»Ÿ - æ•™å­¦ç®¡ç†å‘˜</title>
    <link rel="icon" href="../public/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/modules/dashboard.css">
    <style>
        /* æ•™å­¦ç®¡ç†å‘˜ä¸“ç”¨æ ·å¼ */
        .teaching-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .teaching-nav-item {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .teaching-nav-item:hover {
            background: #e9ecef;
        }

        .teaching-nav-item.active {
            background: #007bff;
            color: white;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .management-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .management-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .management-card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .checkbox-cell {
            width: 40px;
        }

        .timetable-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
            margin-top: 15px;
        }

        .timetable-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }

        .timetable-cell {
            background: white;
            padding: 8px;
            min-height: 60px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .timetable-cell:hover {
            background: #f0f8ff;
        }

        .timetable-cell.occupied {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .conflict-item {
            background: #ffebee;
            border: 1px solid #f44336;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .conflict-item strong {
            color: #d32f2f;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-item .number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .summary-item .label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* è¯¾ç¨‹è¡¨æ ·å¼ */
        .timetable-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .timetable-header {
            display: contents;
        }

        .time-header,
        .day-header {
            background: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        .time-header {
            background: #e9ecef;
            font-weight: bold;
        }

        .timetable-body {
            display: contents;
        }

        .timetable-row {
            display: contents;
        }

        .time-cell {
            background: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timetable-cell {
            background: white;
            min-height: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            position: relative;
            transition: all 0.3s ease;
        }

        .timetable-cell:hover {
            background: #f8f9fa;
        }

        .timetable-cell.drag-over {
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }

        .course-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin: 2px 0;
            cursor: move;
            transition: all 0.3s ease;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .course-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .course-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .course-name {
            font-weight: bold;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .course-teacher {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 1px;
        }

        .course-room {
            font-size: 10px;
            opacity: 0.8;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            margin: 0 2px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="../public/images/icons/favicon.png" alt="æˆç»©ç®¡ç†ç³»ç»Ÿ" class="logo-img">
                    <h1>æˆç»©ç®¡ç†ç³»ç»Ÿ</h1>
                </div>
                <div class="user-info">
                    <span id="userName">æ•™å­¦ç®¡ç†å‘˜</span>
                    <button id="logoutBtn" class="btn btn-primary">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <nav class="nav-menu">
                    <ul>
                        <li class="nav-item active">
                            <a href="#" class="nav-link" data-section="class-management">
                                <img src="../public/images/icons/list.png" alt="ç­çº§ç®¡ç†" class="nav-icon">
                                <span>ç­çº§ç®¡ç†</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="student-management">
                                <img src="../public/images/icons/list.png" alt="å­¦ç”Ÿç®¡ç†" class="nav-icon">
                                <span>å­¦ç”Ÿç®¡ç†</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="course-management-admin">
                                <img src="../public/images/icons/filter.png" alt="è¯¾ç¨‹ç®¡ç†" class="nav-icon">
                                <span>è¯¾ç¨‹ç®¡ç†</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="teacher-management">
                                <img src="../public/images/icons/order.png" alt="æ•™å¸ˆç®¡ç†" class="nav-icon">
                                <span>æ•™å¸ˆç®¡ç†</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="schedule-system">
                                <img src="../public/images/icons/filter.png" alt="è¯¾ç¨‹å®‰æ’ç³»ç»Ÿ" class="nav-icon">
                                <span>è¯¾ç¨‹å®‰æ’ç³»ç»Ÿ</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="operation-logs">
                                <img src="../public/images/icons/order.png" alt="æ“ä½œæ—¥å¿—" class="nav-icon">
                                <span>æ“ä½œæ—¥å¿—</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- å†…å®¹åŒºåŸŸ -->
            <main class="content">
                <div class="content-header">
                    <h2>æ•™å­¦åŸºç¡€æ•°æ®ç®¡ç†</h2>
                    <p>ç®¡ç†ç­çº§ã€è¯¾ç¨‹å®‰æ’å’Œè¯¾ç¨‹è¡¨ç”Ÿæˆ</p>
                </div>

                <!-- ç­çº§ç®¡ç† -->
                <div id="class-management" class="content-section active">

                    <div class="stats-summary">
                        <div class="summary-item">
                            <div class="number" id="totalClasses">0</div>
                            <div class="label">ç­çº§æ€»æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="number" id="totalStudents">0</div>
                            <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="number" id="avgClassSize">0</div>
                            <div class="label">å¹³å‡ç­é¢</div>
                        </div>
                        <div class="summary-item">
                            <div class="number" id="availableSeats">0</div>
                            <div class="label">å‰©ä½™åé¢</div>
                        </div>
                    </div>

                    <div class="management-grid">
                        <div class="management-card">
                            <h3>ç­çº§ä¿¡æ¯ç»´æŠ¤</h3>
                            <div class="form-group">
                                <label>ç­çº§ç¼–å·</label>
                                <input type="text" id="classId" class="form-control" placeholder="å¦‚ï¼šCS202301">
                            </div>
                            <div class="form-group">
                                <label>ç­çº§åç§°</label>
                                <input type="text" id="className" class="form-control" placeholder="å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2023-1ç­">
                            </div>
                            <div class="form-group">
                                <label>ä¸“ä¸š</label>
                                <input type="text" id="classMajor" class="form-control" placeholder="å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯">
                            </div>
                            <div class="form-group">
                                <label>å¹´çº§</label>
                                <select id="classGrade" class="form-control">
                                    <option value="2021">2021çº§</option>
                                    <option value="2022">2022çº§</option>
                                    <option value="2023" selected>2023çº§</option>
                                    <option value="2024">2024çº§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å®¹é‡</label>
                                <input type="number" id="classCapacity" class="form-control" value="40" min="1"
                                    max="100">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="addClassBtn">æ·»åŠ ç­çº§</button>
                                <button class="btn btn-secondary" id="updateClassBtn">æ›´æ–°ç­çº§</button>
                            </div>
                        </div>

                        <div class="management-card">
                            <h3>å­¦ç”Ÿæ‰¹é‡å¯¼å…¥</h3>
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">ğŸ“</div>
                                <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„</p>
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                    æ”¯æŒæ ¼å¼ï¼š.xlsx, .xls<br>
                                    åŒ…å«å­—æ®µï¼šå­¦å·ã€å§“åã€æ€§åˆ«ã€ç­çº§ç¼–å·
                                </p>
                                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="downloadTemplateBtn">ä¸‹è½½æ¨¡æ¿</button>
                                <button class="btn btn-success" id="importBtn">å¼€å§‹å¯¼å…¥</button>
                            </div>
                        </div>
                    </div>

                    <div class="management-card">
                        <h3>ç­çº§åˆ—è¡¨ä¸å­¦ç”Ÿåˆ†ç­</h3>
                        <div class="form-group">
                            <label>æœç´¢ç­çº§</label>
                            <input type="text" id="searchClass" class="form-control" placeholder="è¾“å…¥ç­çº§åç§°æˆ–ç¼–å·">
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">
                                        <input type="checkbox" id="selectAllClasses">
                                    </th>
                                    <th>ç­çº§ç¼–å·</th>
                                    <th>ç­çº§åç§°</th>
                                    <th>ä¸“ä¸š</th>
                                    <th>å¹´çº§</th>
                                    <th>å½“å‰äººæ•°</th>
                                    <th>æœ€å¤§å®¹é‡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="classList">
                                <!-- ç­çº§åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                        <div class="btn-group">
                            <button class="btn btn-warning" id="batchAssignBtn">æ‰¹é‡åˆ†ç­</button>
                            <button class="btn btn-info" id="exportClassBtn">å¯¼å‡ºç­çº§ä¿¡æ¯</button>
                        </div>
                    </div>
                </div>

                <!-- å­¦ç”Ÿç®¡ç† -->
                <div id="student-management" class="content-section">
                    <div class="management-grid">
                        <div class="management-card">
                            <h3>å­¦ç”Ÿä¿¡æ¯ç»´æŠ¤</h3>
                            <div class="form-group">
                                <label>å­¦å·</label>
                                <input type="text" id="studentIdInput" class="form-control" placeholder="å¦‚ï¼š2024001">
                            </div>
                            <div class="form-group">
                                <label>å§“å</label>
                                <input type="text" id="studentNameInput" class="form-control" placeholder="å­¦ç”Ÿå§“å">
                            </div>
                            <div class="form-group">
                                <label>æ€§åˆ«</label>
                                <select id="studentGenderInput" class="form-control">
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç­çº§ç¼–å·</label>
                                <input type="text" id="studentClassInput" class="form-control" placeholder="å¦‚ï¼šCS202301">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="addStudentBtn">æ–°å¢å­¦ç”Ÿ</button>
                                <button class="btn btn-secondary" id="updateStudentBtn">æ›´æ–°å­¦ç”Ÿ</button>
                                <button class="btn btn-danger" id="deleteStudentBtn">åˆ é™¤å­¦ç”Ÿ</button>
                            </div>
                        </div>
                        <div class="management-card">
                            <h3>å­¦ç”Ÿåˆ—è¡¨</h3>
                            <div class="form-group">
                                <label>æœç´¢å­¦ç”Ÿ</label>
                                <input type="text" id="studentSearchInputAdmin" class="form-control"
                                    placeholder="æŒ‰å­¦å·/å§“å/ç­çº§/ä¸“ä¸šæœç´¢">
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>å­¦å·</th>
                                            <th>å§“å</th>
                                            <th>æ€§åˆ«</th>
                                            <th>ç­çº§</th>
                                            <th>å¹´çº§</th>
                                            <th>ä¸“ä¸š</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯¾ç¨‹ç®¡ç† -->
                <div id="course-management-admin" class="content-section">
                    <div class="management-grid">
                        <div class="management-card">
                            <h3>è¯¾ç¨‹ä¿¡æ¯ç»´æŠ¤</h3>
                            <div class="form-group">
                                <label>è¯¾ç¨‹ç¼–å·</label>
                                <input type="text" id="courseIdInputAdmin" class="form-control" placeholder="å¦‚ï¼šCS301A">
                            </div>
                            <div class="form-group">
                                <label>è¯¾ç¨‹åç§°</label>
                                <input type="text" id="courseNameInputAdmin" class="form-control" placeholder="è¯¾ç¨‹åç§°">
                            </div>
                            <div class="form-group">
                                <label>æˆè¯¾æ•™å¸ˆ</label>
                                <input type="text" id="courseTeacherInputAdmin" class="form-control" placeholder="æ•™å¸ˆå§“å">
                            </div>
                            <div class="form-group">
                                <label>å­¦åˆ†</label>
                                <input type="number" id="courseCreditInputAdmin" class="form-control" value="3" min="1"
                                    max="10">
                            </div>
                            <div class="form-group">
                                <label>å­¦æ—¶</label>
                                <input type="number" id="courseHoursInputAdmin" class="form-control" value="48" min="16"
                                    max="128">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="addCourseBtnAdmin">æ–°å¢è¯¾ç¨‹</button>
                                <button class="btn btn-secondary" id="updateCourseBtnAdmin">æ›´æ–°è¯¾ç¨‹</button>
                                <button class="btn btn-danger" id="deleteCourseBtnAdmin">åˆ é™¤è¯¾ç¨‹</button>
                            </div>
                        </div>
                        <div class="management-card">
                            <h3>è¯¾ç¨‹åˆ—è¡¨ä¸æˆç»©å®¡æ ¸</h3>
                            <div class="form-group">
                                <label>æœç´¢è¯¾ç¨‹</label>
                                <input type="text" id="courseSearchInputAdmin" class="form-control"
                                    placeholder="æŒ‰ç¼–å·/åç§°/æ•™å¸ˆæœç´¢">
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>è¯¾ç¨‹ç¼–å·</th>
                                            <th>è¯¾ç¨‹åç§°</th>
                                            <th>æ•™å¸ˆ</th>
                                            <th>å­¦åˆ†</th>
                                            <th>å­¦æ—¶</th>
                                            <th>çŠ¶æ€</th>
                                        </tr>
                                    </thead>
                                    <tbody id="courseTableBodyAdmin"></tbody>
                                </table>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-warning" id="runGradeAuditBtn">æ‰§è¡Œæˆç»©å®¡æ ¸</button>
                                <button class="btn btn-success" id="publishGradesBtn">å‘å¸ƒæˆç»©</button>
                            </div>
                            <div id="gradeAuditResults" style="margin-top:10px;color:#555;"></div>
                        </div>
                    </div>
                </div>

                <!-- æ•™å¸ˆç®¡ç† -->
                <div id="teacher-management" class="content-section">
                    <div class="management-grid">
                        <div class="management-card">
                            <h3>æ•™å¸ˆä¿¡æ¯ç»´æŠ¤</h3>
                            <div class="form-group">
                                <label>æ•™å¸ˆç¼–å·</label>
                                <input type="text" id="teacherIdInputAdmin" class="form-control"
                                    placeholder="å¦‚ï¼šteacher011">
                            </div>
                            <div class="form-group">
                                <label>æ•™å¸ˆå§“å</label>
                                <input type="text" id="teacherNameInputAdmin" class="form-control" placeholder="æ•™å¸ˆå§“å">
                            </div>
                            <div class="form-group">
                                <label>é™¢ç³»</label>
                                <input type="text" id="teacherDeptInputAdmin" class="form-control"
                                    placeholder="å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ç³»">
                            </div>
                            <div class="form-group">
                                <label>èŒç§°</label>
                                <input type="text" id="teacherTitleInputAdmin" class="form-control" placeholder="å¦‚ï¼šæ•™æˆ">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="addTeacherBtnAdmin">æ–°å¢æ•™å¸ˆ</button>
                                <button class="btn btn-secondary" id="updateTeacherBtnAdmin">æ›´æ–°æ•™å¸ˆ</button>
                                <button class="btn btn-danger" id="deleteTeacherBtnAdmin">åˆ é™¤æ•™å¸ˆ</button>
                            </div>
                        </div>
                        <div class="management-card">
                            <h3>æ•™å¸ˆåˆ—è¡¨</h3>
                            <div class="form-group">
                                <label>æœç´¢æ•™å¸ˆ</label>
                                <input type="text" id="teacherSearchInputAdmin" class="form-control"
                                    placeholder="æŒ‰ç¼–å·/å§“å/é™¢ç³»/èŒç§°æœç´¢">
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ç¼–å·</th>
                                            <th>å§“å</th>
                                            <th>é™¢ç³»</th>
                                            <th>èŒç§°</th>
                                            <th>å·¥ä½œé‡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacherTableBodyAdmin"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯¾ç¨‹å®‰æ’ç³»ç»Ÿå®¹å™¨ -->
                <div id="schedule-system" class="content-section">

                    <!-- è¯¾ç¨‹å®‰æ’ç³»ç»Ÿ -->
                    <div id="course-scheduling" class="content-section">

                        <div class="stats-summary">
                            <div class="summary-item">
                                <div class="number" id="totalCourses">0</div>
                                <div class="label">è¯¾ç¨‹æ€»æ•°</div>
                            </div>
                            <div class="summary-item">
                                <div class="number" id="assignedCourses">0</div>
                                <div class="label">å·²å®‰æ’è¯¾ç¨‹</div>
                            </div>
                            <div class="summary-item">
                                <div class="number" id="conflictCount">0</div>
                                <div class="label">å†²çªæ•°é‡</div>
                            </div>
                            <div class="summary-item">
                                <div class="number" id="availableRooms">0</div>
                                <div class="label">å¯ç”¨æ•™å®¤</div>
                            </div>
                        </div>

                        <div class="management-grid">
                            <div class="management-card">
                                <h3>å­¦æœŸå¼€è¯¾è®¡åˆ’</h3>
                                <div class="form-group">
                                    <label>å­¦æœŸ</label>
                                    <select id="semester" class="form-control">
                                        <option value="2024-1">2024å¹´æ˜¥å­£å­¦æœŸ</option>
                                        <option value="2024-2" selected>2024å¹´ç§‹å­£å­¦æœŸ</option>
                                        <option value="2025-1">2025å¹´æ˜¥å­£å­¦æœŸ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>è¯¾ç¨‹åç§°</label>
                                    <select id="courseSelect" class="form-control">
                                        <option value="">é€‰æ‹©è¯¾ç¨‹</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>æˆè¯¾æ•™å¸ˆ</label>
                                    <select id="teacherSelect" class="form-control">
                                        <option value="">é€‰æ‹©æ•™å¸ˆ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ä¸Šè¯¾ç­çº§</label>
                                    <select id="courseClassSelect" class="form-control">
                                        <option value="">é€‰æ‹©ç­çº§</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>å­¦æ—¶</label>
                                    <input type="number" id="courseHours" class="form-control" value="64" min="16"
                                        max="128">
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" id="addCoursePlanBtn">æ·»åŠ åˆ°è®¡åˆ’</button>
                                    <button class="btn btn-info" id="importMockCoursesBtn">å¯¼å…¥æ¨¡æ‹Ÿæ•°æ®</button>
                                    <button class="btn btn-secondary" id="autoScheduleBtn">è‡ªåŠ¨æ’è¯¾</button>
                                </div>

                            </div>

                            <div class="management-card">
                                <h3>æ•™å¸ˆä¸æ•™å®¤å®‰æ’</h3>
                                <div class="form-group">
                                    <label>æ•™å¸ˆå·¥ä½œé‡é™åˆ¶</label>
                                    <input type="number" id="teacherWorkload" class="form-control" value="20" min="1"
                                        max="40">
                                </div>
                                <div class="form-group">
                                    <label>æ•™å®¤ç±»å‹</label>
                                    <select id="roomType" class="form-control">
                                        <option value="lecture">é˜¶æ¢¯æ•™å®¤</option>
                                        <option value="lab">å®éªŒå®¤</option>
                                        <option value="computer">æœºæˆ¿</option>
                                        <option value="regular">æ™®é€šæ•™å®¤</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>æœ€å°å®¹é‡</label>
                                    <input type="number" id="minCapacity" class="form-control" value="30" min="1"
                                        max="200">
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" id="checkAvailabilityBtn">æ£€æŸ¥å¯ç”¨æ€§</button>
                                    <button class="btn btn-warning" id="detectConflictsBtn">æ£€æµ‹å†²çª</button>
                                </div>
                            </div>
                        </div>

                        <div class="management-card">
                            <h3>è¯¾ç¨‹è®¡åˆ’åˆ—è¡¨</h3>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-cell">
                                            <input type="checkbox" id="selectAllCourses">
                                        </th>
                                        <th>è¯¾ç¨‹ç¼–å·</th>
                                        <th>è¯¾ç¨‹åç§°</th>
                                        <th>æˆè¯¾æ•™å¸ˆ</th>
                                        <th>ä¸Šè¯¾ç­çº§</th>
                                        <th>å­¦æ—¶</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="coursePlanList">
                                    <!-- è¯¾ç¨‹è®¡åˆ’åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>

                        <div class="management-card">
                            <h3>å†²çªæ£€æµ‹ç»“æœ</h3>
                            <div id="conflictList">
                                <!-- å†²çªåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- è¯¾ç¨‹è¡¨ç”Ÿæˆ -->
                    <div id="timetable" class="content-section">
                        <div class="management-grid">
                            <div class="management-card">
                                <h3>è¯¾ç¨‹è¡¨è®¾ç½®</h3>
                                <div class="form-group">
                                    <label>é€‰æ‹©ç­çº§</label>
                                    <select id="timetableClassSelect" class="form-control">
                                        <option value="">é€‰æ‹©ç­çº§</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>é€‰æ‹©æ•™å¸ˆ</label>
                                    <select id="timetableTeacherSelect" class="form-control">
                                        <option value="">é€‰æ‹©æ•™å¸ˆ</option>
                                    </select>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" id="addTimetableBtn">æ·»åŠ è¯¾ç¨‹</button>
                                    <button class="btn btn-success" id="generateTimetableBtn">ç”Ÿæˆè¯¾ç¨‹è¡¨</button>
                                    <button class="btn btn-info" id="exportTimetableBtn">å¯¼å‡ºè¯¾ç¨‹è¡¨</button>
                                </div>
                            </div>

                            <div class="management-card">
                                <h3>è¯¾ç¨‹è¡¨ç»Ÿè®¡</h3>
                                <div class="stats-summary">
                                    <div class="summary-item">
                                        <div class="number" id="totalCourses">0</div>
                                        <div class="label">æ€»è¯¾ç¨‹æ•°</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="number" id="weekCourses">0</div>
                                        <div class="label">æœ¬å‘¨è¯¾ç¨‹</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="number" id="conflictCount">0</div>
                                        <div class="label">å†²çªæ•°é‡</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="number" id="availableRooms">0</div>
                                        <div class="label">å¯ç”¨æ•™å®¤</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="management-card">
                            <h3>å¯è§†åŒ–è¯¾ç¨‹è¡¨</h3>
                            <div class="timetable-grid" id="timetableGrid">
                                <!-- è¯¾ç¨‹è¡¨ç½‘æ ¼å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-secondary"
                                    onclick="TeachingAdminModule.clearTimetable()">æ¸…ç©ºè¯¾ç¨‹è¡¨</button>
                                <button class="btn btn-info"
                                    onclick="TeachingAdminModule.printTimetable()">æ‰“å°è¯¾ç¨‹è¡¨</button>
                            </div>
                        </div>

                        <div class="management-card">
                            <h3>è¯¾ç¨‹è¡¨åˆ—è¡¨</h3>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>è¯¾ç¨‹åç§°</th>
                                            <th>æ•™å¸ˆå§“å</th>
                                            <th>ç­çº§åç§°</th>
                                            <th>æ˜ŸæœŸ</th>
                                            <th>èŠ‚æ¬¡</th>
                                            <th>æ•™å®¤åç§°</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="timetableList">
                                        <!-- è¯¾ç¨‹è¡¨åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div> <!-- end schedule-system -->

                <!-- æ“ä½œæ—¥å¿—ç®¡ç† -->
                <div id="operation-logs" class="content-section">
                    <div class="stats-summary">
                        <div class="summary-item">
                            <div class="number" id="totalLogs">0</div>
                            <div class="label">æ€»æ—¥å¿—æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="number" id="todayLogs">0</div>
                            <div class="label">ä»Šæ—¥æ—¥å¿—</div>
                        </div>
                        <div class="summary-item">
                            <div class="number" id="teacherLogs">0</div>
                            <div class="label">æ•™å¸ˆæ“ä½œ</div>
                        </div>
                        <div class="summary-item">
                            <div class="number" id="studentLogs">0</div>
                            <div class="label">å­¦ç”Ÿæ“ä½œ</div>
                        </div>
                    </div>

                    <div class="management-card">
                        <h3>æ“ä½œæ—¥å¿—æŸ¥è¯¢</h3>
                        <div class="management-grid"
                            style="grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>ç”¨æˆ·ç±»å‹</label>
                                <select id="logUserTypeFilter" class="form-control">
                                    <option value="">å…¨éƒ¨ç±»å‹</option>
                                    <option value="teacher">æ•™å¸ˆ</option>
                                    <option value="student">å­¦ç”Ÿ</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ“ä½œç±»å‹</label>
                                <select id="logActionTypeFilter" class="form-control">
                                    <option value="">å…¨éƒ¨æ“ä½œ</option>
                                    <option value="login">ç™»å½•</option>
                                    <option value="logout">ç™»å‡º</option>
                                    <option value="grade">æˆç»©æ“ä½œ</option>
                                    <option value="course">è¯¾ç¨‹æ“ä½œ</option>
                                    <option value="assignment">ä½œä¸š/è€ƒè¯•</option>
                                    <option value="student">å­¦ç”Ÿç®¡ç†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="logStartDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="logEndDate" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æœç´¢å…³é”®è¯</label>
                            <input type="text" id="logSearchInput" class="form-control" placeholder="æŒ‰ç”¨æˆ·åã€æ“ä½œè¯¦æƒ…æœç´¢...">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="searchLogsBtn">æŸ¥è¯¢æ—¥å¿—</button>
                            <button class="btn btn-secondary" id="resetLogFilterBtn">é‡ç½®ç­›é€‰</button>
                            <button class="btn btn-success" id="exportLogsBtn">ğŸ“¥ å¯¼å‡ºCSV</button>
                            <button class="btn btn-warning" id="generateMockLogsBtn">ç”Ÿæˆæµ‹è¯•æ•°æ®</button>
                        </div>
                    </div>

                    <div class="management-card">
                        <h3>æ—¥å¿—è®°å½•åˆ—è¡¨</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>ç”¨æˆ·</th>
                                        <th>è§’è‰²</th>
                                        <th>æ“ä½œç±»å‹</th>
                                        <th>æ“ä½œè¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody id="operationLogTableBody">
                                    <!-- æ—¥å¿—åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                        <div id="logPagination" style="margin-top: 15px; text-align: center;"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <!-- è¯¾ç¨‹è¡¨æ¨¡æ€æ¡† -->
    <div id="timetableModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ è¯¾ç¨‹è¡¨é¡¹</h3>
                <span class="close" onclick="TeachingAdminModule.closeTimetableModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="timetableForm">
                    <div class="form-group">
                        <label>é€‰æ‹©è¯¾ç¨‹</label>
                        <select id="timetableCourseSelect" class="form-control" required>
                            <option value="">é€‰æ‹©è¯¾ç¨‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æ•™å¸ˆ</label>
                        <select id="timetableTeacherSelect" class="form-control" required>
                            <option value="">é€‰æ‹©æ•™å¸ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©ç­çº§</label>
                        <select id="timetableClassSelect" class="form-control" required>
                            <option value="">é€‰æ‹©ç­çº§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æ•™å®¤</label>
                        <select id="timetableRoomSelect" class="form-control" required>
                            <option value="">é€‰æ‹©æ•™å®¤</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ˜ŸæœŸ</label>
                        <select id="timetableDaySelect" class="form-control" required>
                            <option value="">é€‰æ‹©æ˜ŸæœŸ</option>
                            <option value="1">å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èŠ‚æ¬¡</label>
                        <select id="timetableTimeSelect" class="form-control" required>
                            <option value="">é€‰æ‹©èŠ‚æ¬¡</option>
                            <option value="1-2">ç¬¬1-2èŠ‚</option>
                            <option value="3-4">ç¬¬3-4èŠ‚</option>
                            <option value="5-6">ç¬¬5-6èŠ‚</option>
                            <option value="7-8">ç¬¬7-8èŠ‚</option>
                            <option value="9-10">ç¬¬9-10èŠ‚</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveTimetableBtn"
                    onclick="TeachingAdminModule.saveTimetableItem()">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary"
                    onclick="TeachingAdminModule.closeTimetableModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/utils.js"></script>
    <script src="../js/modules/auth.js"></script>
    <script src="../js/data/users.js"></script>
    <script src="../js/data/students.js"></script>

    <script src="../js/data/teachers.js"></script>
    <script src="../js/data/classrooms.js"></script>
    <script src="../js/data/courses.js"></script>
    <script src="../js/modules/CourseModule.js"></script>
    <script src="../js/pages/teaching-admin.js"></script>

    <script>
        (function () {
            const rootSections = ['class-management', 'student-management', 'course-management-admin', 'teacher-management', 'schedule-system'];

            function showRootSection(id) {
                rootSections.forEach(sec => {
                    const el = document.getElementById(sec);
                    if (el) el.style.display = sec === id ? 'block' : 'none';
                });
                if (id === 'schedule-system') {
                    ['course-scheduling', 'timetable'].forEach(sec => {
                        const el = document.getElementById(sec);
                        if (el) el.style.display = 'block';
                    });
                }
            }

            // ===== æ•°æ®è¯»å–ä¸ç¼“å­˜ =====
            const storageKeys = {
                students: 'adminStudents',
                courses: 'adminCourses',
                teachers: 'adminTeachers'
            };

            function getStudentData() {
                const cached = JSON.parse(localStorage.getItem(storageKeys.students) || 'null');
                return Array.isArray(cached) && cached.length ? cached : (window.StudentsModule ? StudentsModule.getAllStudents() : []);
            }
            function saveStudentData(list) { localStorage.setItem(storageKeys.students, JSON.stringify(list)); }

            function getCourseData() {
                const cached = JSON.parse(localStorage.getItem(storageKeys.courses) || 'null');
                return Array.isArray(cached) && cached.length ? cached : (window.coursesData ? [...coursesData] : []);
            }
            function saveCourseData(list) { localStorage.setItem(storageKeys.courses, JSON.stringify(list)); }

            function getTeacherData() {
                const cached = JSON.parse(localStorage.getItem(storageKeys.teachers) || 'null');
                return Array.isArray(cached) && cached.length ? cached : (window.TeachersModule ? TeachersModule.getAllTeachers() : []);
            }
            function saveTeacherData(list) { localStorage.setItem(storageKeys.teachers, JSON.stringify(list)); }

            // ===== æ¸²æŸ“å‡½æ•° =====
            function renderStudents(filter = '') {
                const tbody = document.getElementById('studentTableBody');
                if (!tbody) return;
                const list = getStudentData();
                const lower = filter.toLowerCase();
                const filtered = filter ? list.filter(s =>
                    s.id.toLowerCase().includes(lower) ||
                    s.name.toLowerCase().includes(lower) ||
                    (s.classId || '').toLowerCase().includes(lower) ||
                    (s.major || '').toLowerCase().includes(lower)
                ) : list;
                tbody.innerHTML = filtered.map(s => `
            <tr>
              <td>${s.id}</td>
              <td>${s.name}</td>
              <td>${s.gender || ''}</td>
              <td>${s.classId || ''}</td>
              <td>${s.grade || ''}</td>
              <td>${s.major || ''}</td>
            </tr>
          `).join('');
            }

            function renderCourses(filter = '') {
                const tbody = document.getElementById('courseTableBodyAdmin');
                if (!tbody) return;
                const list = getCourseData();
                const lower = filter.toLowerCase();
                const filtered = filter ? list.filter(c =>
                    c.id.toLowerCase().includes(lower) ||
                    c.name.toLowerCase().includes(lower) ||
                    (c.teacher || '').toLowerCase().includes(lower)
                ) : list;
                tbody.innerHTML = filtered.map(c => `
            <tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.teacher || ''}</td>
              <td>${c.credit || ''}</td>
              <td>${c.hours || ''}</td>
              <td>${c.status || 'è¿›è¡Œä¸­'}</td>
            </tr>
          `).join('');
            }

            function renderTeachers(filter = '') {
                const tbody = document.getElementById('teacherTableBodyAdmin');
                if (!tbody) return;
                const list = getTeacherData();
                const lower = filter.toLowerCase();
                const filtered = filter ? list.filter(t =>
                    t.id.toLowerCase().includes(lower) ||
                    t.name.toLowerCase().includes(lower) ||
                    (t.department || '').toLowerCase().includes(lower) ||
                    (t.title || '').toLowerCase().includes(lower)
                ) : list;
                tbody.innerHTML = filtered.map(t => `
            <tr>
              <td>${t.id}</td>
              <td>${t.name}</td>
              <td>${t.department || ''}</td>
              <td>${t.title || ''}</td>
              <td>${t.currentWorkload || 0}/${t.maxWorkload || 0}</td>
            </tr>
          `).join('');
            }

            // ===== CRUD äº‹ä»¶ç»‘å®š =====
            function bindStudentEvents() {
                const addBtn = document.getElementById('addStudentBtn');
                const updBtn = document.getElementById('updateStudentBtn');
                const delBtn = document.getElementById('deleteStudentBtn');
                const searchInput = document.getElementById('studentSearchInputAdmin');

                const getFormValues = () => ({
                    id: document.getElementById('studentIdInput').value.trim(),
                    name: document.getElementById('studentNameInput').value.trim(),
                    gender: document.getElementById('studentGenderInput').value,
                    classId: document.getElementById('studentClassInput').value.trim()
                });

                addBtn && addBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id || !data.name) return alert('è¯·å¡«å†™å­¦å·å’Œå§“å');
                    const list = getStudentData();
                    if (list.find(s => s.id === data.id)) return alert('å­¦å·å·²å­˜åœ¨');
                    list.push({ ...data, grade: data.id.slice(0, 4) || '', major: data.major || '' });
                    saveStudentData(list);
                    renderStudents(searchInput ? searchInput.value : '');
                });

                updBtn && updBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id) return alert('è¯·è¾“å…¥è¦æ›´æ–°çš„å­¦å·');
                    const list = getStudentData();
                    const idx = list.findIndex(s => s.id === data.id);
                    if (idx === -1) return alert('æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿ');
                    list[idx] = { ...list[idx], ...data };
                    saveStudentData(list);
                    renderStudents(searchInput ? searchInput.value : '');
                });

                delBtn && delBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id) return alert('è¯·è¾“å…¥è¦åˆ é™¤çš„å­¦å·');
                    const list = getStudentData().filter(s => s.id !== data.id);
                    saveStudentData(list);
                    renderStudents(searchInput ? searchInput.value : '');
                });

                searchInput && searchInput.addEventListener('input', e => renderStudents(e.target.value));
            }

            function bindCourseEvents() {
                const addBtn = document.getElementById('addCourseBtnAdmin');
                const updBtn = document.getElementById('updateCourseBtnAdmin');
                const delBtn = document.getElementById('deleteCourseBtnAdmin');
                const searchInput = document.getElementById('courseSearchInputAdmin');

                const getFormValues = () => ({
                    id: document.getElementById('courseIdInputAdmin').value.trim(),
                    name: document.getElementById('courseNameInputAdmin').value.trim(),
                    teacher: document.getElementById('courseTeacherInputAdmin').value.trim(),
                    credit: parseInt(document.getElementById('courseCreditInputAdmin').value, 10) || 0,
                    hours: parseInt(document.getElementById('courseHoursInputAdmin').value, 10) || 0
                });

                addBtn && addBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id || !data.name) return alert('è¯·å¡«å†™è¯¾ç¨‹ç¼–å·å’Œåç§°');
                    const list = getCourseData();
                    if (list.find(c => c.id === data.id)) return alert('è¯¾ç¨‹ç¼–å·å·²å­˜åœ¨');
                    list.push({ ...data, status: 'è¿›è¡Œä¸­' });
                    saveCourseData(list);
                    renderCourses(searchInput ? searchInput.value : '');
                });

                updBtn && updBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id) return alert('è¯·è¾“å…¥è¯¾ç¨‹ç¼–å·');
                    const list = getCourseData();
                    const idx = list.findIndex(c => c.id === data.id);
                    if (idx === -1) return alert('æœªæ‰¾åˆ°è¯¥è¯¾ç¨‹');
                    list[idx] = { ...list[idx], ...data };
                    saveCourseData(list);
                    renderCourses(searchInput ? searchInput.value : '');
                });

                delBtn && delBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id) return alert('è¯·è¾“å…¥è¦åˆ é™¤çš„è¯¾ç¨‹ç¼–å·');
                    const list = getCourseData().filter(c => c.id !== data.id);
                    saveCourseData(list);
                    renderCourses(searchInput ? searchInput.value : '');
                });

                searchInput && searchInput.addEventListener('input', e => renderCourses(e.target.value));
            }

            function bindTeacherEvents() {
                const addBtn = document.getElementById('addTeacherBtnAdmin');
                const updBtn = document.getElementById('updateTeacherBtnAdmin');
                const delBtn = document.getElementById('deleteTeacherBtnAdmin');
                const searchInput = document.getElementById('teacherSearchInputAdmin');

                const getFormValues = () => ({
                    id: document.getElementById('teacherIdInputAdmin').value.trim(),
                    name: document.getElementById('teacherNameInputAdmin').value.trim(),
                    department: document.getElementById('teacherDeptInputAdmin').value.trim(),
                    title: document.getElementById('teacherTitleInputAdmin').value.trim()
                });

                addBtn && addBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id || !data.name) return alert('è¯·å¡«å†™æ•™å¸ˆç¼–å·å’Œå§“å');
                    const list = getTeacherData();
                    if (list.find(t => t.id === data.id)) return alert('æ•™å¸ˆç¼–å·å·²å­˜åœ¨');
                    list.push({ ...data, maxWorkload: 20, currentWorkload: 0, status: 'active' });
                    saveTeacherData(list);
                    renderTeachers(searchInput ? searchInput.value : '');
                });

                updBtn && updBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id) return alert('è¯·è¾“å…¥æ•™å¸ˆç¼–å·');
                    const list = getTeacherData();
                    const idx = list.findIndex(t => t.id === data.id);
                    if (idx === -1) return alert('æœªæ‰¾åˆ°è¯¥æ•™å¸ˆ');
                    list[idx] = { ...list[idx], ...data };
                    saveTeacherData(list);
                    renderTeachers(searchInput ? searchInput.value : '');
                });

                delBtn && delBtn.addEventListener('click', () => {
                    const data = getFormValues();
                    if (!data.id) return alert('è¯·è¾“å…¥è¦åˆ é™¤çš„æ•™å¸ˆç¼–å·');
                    const list = getTeacherData().filter(t => t.id !== data.id);
                    saveTeacherData(list);
                    renderTeachers(searchInput ? searchInput.value : '');
                });

                searchInput && searchInput.addEventListener('input', e => renderTeachers(e.target.value));
            }

            // ===== æˆç»©å®¡æ ¸ä¸å‘å¸ƒ =====
            function runGradeAudit() {
                const resultsEl = document.getElementById('gradeAuditResults');
                const courses = getCourseData();
                const courseAnomalies = [];
                const studentAnomalies = [];

                courses.forEach(course => {
                    const gradeDataStr = sessionStorage.getItem(`courseGrades_${course.id}`);
                    if (!gradeDataStr) return;
                    const gradeData = JSON.parse(gradeDataStr || '[]');
                    if (!gradeData.length) return;
                    const totals = gradeData.map(g => g.total || 0);
                    const excellentRate = totals.filter(t => t >= 90).length / totals.length;
                    const passRate = totals.filter(t => t >= 60).length / totals.length;
                    if (excellentRate > 0.3 || passRate < 0.6) {
                        courseAnomalies.push({ courseId: course.id, name: course.name, excellentRate, passRate });
                    }
                    // å­¦ç”Ÿæˆç»©æ³¢åŠ¨ï¼ˆå¯¹æ¯”ä¸Šä¸€é—¨è¯¾ç¨‹è‹¥å­˜åœ¨ï¼‰
                    for (let i = 1; i < totals.length; i++) {
                        const diff = Math.abs(totals[i] - totals[i - 1]);
                        if (diff > 20) {
                            studentAnomalies.push({ courseId: course.id, studentId: gradeData[i].studentId, diff });
                        }
                    }
                });

                const renderList = () => {
                    let html = '';
                    if (courseAnomalies.length === 0 && studentAnomalies.length === 0) {
                        html = '<p>æœªå‘ç°å¼‚å¸¸æ•°æ®ï¼Œå®¡æ ¸é€šè¿‡ã€‚</p>';
                    } else {
                        if (courseAnomalies.length) {
                            html += '<p><strong>è¯¾ç¨‹å¼‚å¸¸</strong></p><ul>' + courseAnomalies.map(a => `
                  <li>${a.courseId} ${a.name}ï¼šä¼˜ç§€ç‡ ${(a.excellentRate * 100).toFixed(1)}%ï¼ŒåŠæ ¼ç‡ ${(a.passRate * 100).toFixed(1)}%</li>
                `).join('') + '</ul>';
                        }
                        if (studentAnomalies.length) {
                            html += '<p><strong>å­¦ç”Ÿæˆç»©æ³¢åŠ¨å¼‚å¸¸</strong></p><ul>' + studentAnomalies.slice(0, 10).map(s => `
                  <li>è¯¾ç¨‹ ${s.courseId} å­¦ç”Ÿ ${s.studentId} æ³¢åŠ¨ ${s.diff} åˆ†</li>
                `).join('') + '</ul>';
                        }
                    }
                    return html;
                };

                if (resultsEl) {
                    resultsEl.innerHTML = renderList();
                }
                return { courseAnomalies, studentAnomalies };
            }

            function publishGrades() {
                const list = getCourseData().map(c => ({ ...c, status: 'å·²å‘å¸ƒ' }));
                saveCourseData(list);
                renderCourses();
                alert('æˆç»©å·²å‘å¸ƒï¼Œå­¦ç”Ÿç«¯å¯å®æ—¶æŸ¥çœ‹ã€‚');
            }

            // ===== ç­çº§æ¨¡æ‹Ÿå¯¼å…¥ä¸æ–°å¢ï¼ˆå…¨é“¾è·¯æ¨¡æ‹Ÿï¼‰ =====
            const mockClassApi = {
                load() {
                    const cached = JSON.parse(localStorage.getItem('classes') || 'null');
                    return Array.isArray(cached) && cached.length ? cached : [
                        { id: 'CS202301', name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2023-1ç­', major: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', grade: '2023', capacity: 40 },
                        { id: 'CS202302', name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2023-2ç­', major: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', grade: '2023', capacity: 40 },
                        { id: 'SE202301', name: 'è½¯ä»¶å·¥ç¨‹2023-1ç­', major: 'è½¯ä»¶å·¥ç¨‹', grade: '2023', capacity: 35 },
                        { id: 'MATH202301', name: 'æ•°å­¦ä¸åº”ç”¨æ•°å­¦2023-1ç­', major: 'æ•°å­¦ä¸åº”ç”¨æ•°å­¦', grade: '2023', capacity: 30 }
                    ];
                },
                save(list) {
                    localStorage.setItem('classes', JSON.stringify(list));
                    return list;
                },
                async add(payload) {
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            if (!payload.id || !payload.name || !payload.major || !payload.grade) {
                                reject(new Error('ç­çº§ç¼–å·ã€åç§°ã€ä¸“ä¸šã€å¹´çº§ä¸ºå¿…å¡«'));
                                return;
                            }
                            if (!/^[-A-Za-z0-9]+$/.test(payload.id)) {
                                reject(new Error('ç­çº§ç¼–å·ä»…å…è®¸å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦'));
                                return;
                            }
                            const capacity = Number(payload.capacity || 0);
                            if (Number.isNaN(capacity) || capacity < 1 || capacity > 200) {
                                reject(new Error('å®¹é‡éœ€åœ¨1-200ä¹‹é—´'));
                                return;
                            }
                            const list = this.load();
                            if (list.find(c => c.id === payload.id)) {
                                reject(new Error('ç­çº§ç¼–å·å·²å­˜åœ¨'));
                                return;
                            }
                            const newClass = {
                                id: payload.id,
                                name: payload.name,
                                major: payload.major,
                                grade: payload.grade,
                                capacity,
                                headTeacher: payload.headTeacher || 'æœªæŒ‡å®š',
                                createTime: new Date().toISOString().split('T')[0]
                            };
                            list.push(newClass);
                            this.save(list);
                            resolve({ data: newClass });
                        }, 150);
                    });
                },
                importBatch(batch) {
                    const list = this.load();
                    const errors = [];
                    batch.forEach((item, idx) => {
                        if (!item.id || !item.name || !item.major || !item.grade) {
                            errors.push({ row: idx + 1, error: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' });
                            return;
                        }
                        if (list.find(c => c.id === item.id)) return; // å¿½ç•¥å·²å­˜åœ¨
                        list.push({
                            id: item.id,
                            name: item.name,
                            major: item.major,
                            grade: item.grade,
                            capacity: item.capacity || 40,
                            headTeacher: item.headTeacher || 'æœªæŒ‡å®š',
                            createTime: item.createTime || new Date().toISOString().split('T')[0]
                        });
                    });
                    this.save(list);
                    return { total: batch.length, success: batch.length - errors.length, errors };
                },
                assignStudents(assignments) {
                    const result = { success: 0, failed: [] };
                    const students = window.StudentsModule ? StudentsModule.getAllStudents() : [];
                    assignments.forEach(a => {
                        const stu = students.find(s => s.id === a.studentId);
                        if (stu) {
                            stu.classId = a.classId;
                            result.success += 1;
                        } else {
                            result.failed.push({ studentId: a.studentId, error: 'å­¦ç”Ÿä¸å­˜åœ¨' });
                        }
                    });
                    return result;
                }
            };

            const demoImportClasses = [
                { id: 'CS202401', name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2024-1ç­', major: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', grade: '2024', capacity: 38, headTeacher: 'èµµè€å¸ˆ' },
                { id: 'CS202402', name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2024-2ç­', major: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', grade: '2024', capacity: 40, headTeacher: 'é’±è€å¸ˆ' },
                { id: 'MATH202401', name: 'æ•°å­¦ä¸åº”ç”¨æ•°å­¦2024-1ç­', major: 'æ•°å­¦ä¸åº”ç”¨æ•°å­¦', grade: '2024', capacity: 32, headTeacher: 'å­™è€å¸ˆ' }
            ];

            const demoAssignments = [
                { studentId: '2024001', classId: 'CS202401' },
                { studentId: '2024002', classId: 'CS202401' },
                { studentId: '2024003', classId: 'CS202402' },
                { studentId: '2024004', classId: 'CS202402' },
                { studentId: '2021006', classId: 'MATH202401' }
            ];

            function renderClassListMock() {
                const tbody = document.getElementById('classList');
                if (!tbody) return;
                const classes = mockClassApi.load();
                const students = window.StudentsModule ? StudentsModule.getAllStudents() : [];
                tbody.innerHTML = classes.map(cls => {
                    const studentCount = students.filter(s => s.classId === cls.id).length;
                    return `
              <tr>
                <td class="checkbox-cell"><input type="checkbox" class="class-checkbox" data-class-id="${cls.id}"></td>
                <td>${cls.id}</td>
                <td>${cls.name}</td>
                <td>${cls.major}</td>
                <td>${cls.grade}çº§</td>
                <td>${studentCount}</td>
                <td>${cls.capacity}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="TeachingAdminModule?.editClass ? TeachingAdminModule.editClass('${cls.id}') : null">ç¼–è¾‘</button>
                  <button class="btn btn-sm btn-info" onclick="TeachingAdminModule?.viewStudents ? TeachingAdminModule.viewStudents('${cls.id}') : null">æŸ¥çœ‹å­¦ç”Ÿ</button>
                </td>
              </tr>`;
                }).join('');
            }

            function updateClassStatsMock() {
                const classes = mockClassApi.load();
                const students = window.StudentsModule ? StudentsModule.getAllStudents() : [];
                const totalClasses = classes.length;
                const totalStudents = students.length;
                const avgClassSize = totalClasses ? Math.round(totalStudents / totalClasses) : 0;
                let totalCapacity = 0;
                let totalOccupied = 0;
                classes.forEach(cls => {
                    totalCapacity += Number(cls.capacity || 0);
                    totalOccupied += students.filter(s => s.classId === cls.id).length;
                });
                const availableSeats = totalCapacity - totalOccupied;
                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                setText('totalClasses', totalClasses);
                setText('totalStudents', totalStudents);
                setText('avgClassSize', avgClassSize);
                setText('availableSeats', availableSeats);
            }

            function handleAddClassSubmit(e) {
                if (e) { e.preventDefault(); e.stopImmediatePropagation(); }
                const payload = {
                    id: document.getElementById('classId')?.value.trim(),
                    name: document.getElementById('className')?.value.trim(),
                    major: document.getElementById('classMajor')?.value.trim(),
                    grade: document.getElementById('classGrade')?.value,
                    capacity: Number(document.getElementById('classCapacity')?.value || 0),
                    headTeacher: 'æœªæŒ‡å®š'
                };
                mockClassApi.add(payload)
                    .then(() => {
                        renderClassListMock();
                        updateClassStatsMock();
                        alert('ç­çº§æ·»åŠ æˆåŠŸï¼ˆå·²æ¨¡æ‹Ÿå­˜å‚¨åˆ°æœ¬åœ°æ•°æ®åº“ï¼‰');
                    })
                    .catch(err => alert(err.message));
            }

            function handleMockImport(e) {
                if (e) { e.preventDefault(); e.stopImmediatePropagation(); }
                const importResult = mockClassApi.importBatch(demoImportClasses);
                const assignResult = mockClassApi.assignStudents(demoAssignments);
                renderClassListMock();
                updateClassStatsMock();
                alert(`æ¨¡æ‹Ÿå¯¼å…¥å®Œæˆï¼šæ–°å¢/åˆå¹¶ ${importResult.success} æ¡ï¼Œåˆ†ç­æˆåŠŸ ${assignResult.success} æ¡${assignResult.failed.length ? `ï¼Œå¤±è´¥ ${assignResult.failed.length} æ¡` : ''}`);
            }

            function bindClassMockActions() {
                const addBtn = document.getElementById('addClassBtn');
                if (addBtn) addBtn.addEventListener('click', handleAddClassSubmit, true);
                const importBtn = document.getElementById('importBtn');
                if (importBtn) importBtn.addEventListener('click', handleMockImport, true);
            }

            // ===== å¯¼èˆªç»‘å®š =====
            function bindNav() {

                const navLinks = document.querySelectorAll('.sidebar .nav-link[data-section]');

                const setActive = (link) => {
                    navLinks.forEach(l => {
                        l.classList.remove('active');
                        l.parentElement?.classList.remove('active');
                    });
                    link.classList.add('active');
                    link.parentElement?.classList.add('active');
                };

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        setActive(link);
                        showRootSection(link.dataset.section);
                    });
                });

                const initial = Array.from(navLinks).find(l => l.classList.contains('active')) || navLinks[0];
                if (initial) {
                    setActive(initial);
                    showRootSection(initial.dataset.section);
                }
            }


            document.addEventListener('DOMContentLoaded', function () {
                bindNav();
                bindClassMockActions();
                renderClassListMock();
                updateClassStatsMock();
                renderStudents();
                renderCourses();
                renderTeachers();
                bindStudentEvents();
                bindCourseEvents();
                bindTeacherEvents();
                const auditBtn = document.getElementById('runGradeAuditBtn');
                const publishBtn = document.getElementById('publishGradesBtn');
                auditBtn && auditBtn.addEventListener('click', runGradeAudit);
                publishBtn && publishBtn.addEventListener('click', publishGrades);
            });
        })();

    </script>
</body>

</html>