<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¿˜è®°å¯†ç  - æˆç»©ç®¡ç†æ•™å­¦å¹³å°</title>
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/modules/login.css">
  <style>
    body {
      background: linear-gradient(135deg, #e6f7ff, #b3d9ff);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo-title {
      position: absolute;
      top: var(--space-lg);
      left: var(--space-lg);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .logo-title h1 {
      font-size: 24px;
      font-weight: bold;
    }

    .reset-container {
      width: 420px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--space-xl);
    }

    .reset-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }

    .reset-header h2 {
      font-size: 22px;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .reset-header p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
    .steps-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: var(--space-xl);
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border-color);
      transition: all 0.3s ease;
    }

    .step-dot.active {
      background: var(--primary-color);
      transform: scale(1.2);
    }

    .step-dot.completed {
      background: var(--secondary-color);
    }

    /* è¡¨å•æ ·å¼ */
    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-group label {
      display: block;
      margin-bottom: var(--space-xs);
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: var(--space-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .form-control.error {
      border-color: #e74c3c;
      box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
    }

    .error-message {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 6px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* éªŒè¯ç è¾“å…¥æ¡† */
    .code-input-group {
      display: flex;
      gap: 10px;
    }

    .code-input-group .form-control {
      flex: 1;
    }

    .send-code-btn {
      padding: 0 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.3s ease;
    }

    .send-code-btn:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .send-code-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    /* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */
    .password-strength {
      margin-top: 8px;
      display: flex;
      gap: 4px;
    }

    .strength-bar {
      height: 4px;
      flex: 1;
      background: #e0e0e0;
      border-radius: 2px;
      transition: background 0.3s ease;
    }

    .strength-bar.weak {
      background: #e74c3c;
    }

    .strength-bar.medium {
      background: #f39c12;
    }

    .strength-bar.strong {
      background: #27ae60;
    }

    .strength-text {
      font-size: 12px;
      margin-top: 4px;
      color: var(--text-secondary);
    }

    /* æŒ‰é’® */
    .submit-btn {
      width: 100%;
      font-size: 16px;
      padding: var(--space-md);
      margin-top: var(--space-md);
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .submit-btn:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .submit-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    /* è¿”å›ç™»å½• */
    .back-link {
      text-align: center;
      margin-top: var(--space-lg);
      font-size: 13px;
    }

    .back-link a {
      color: var(--primary-color);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    /* æˆåŠŸæç¤º */
    .success-message {
      text-align: center;
      padding: var(--space-xl) 0;
    }

    .success-icon {
      font-size: 64px;
      margin-bottom: var(--space-md);
    }

    .success-message h3 {
      font-size: 20px;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .success-message p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: var(--space-lg);
    }

    /* éšè—æ­¥éª¤ */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* æç¤ºä¿¡æ¯ */
    .info-box {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      font-size: 13px;
      color: #1565c0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .info-box span:first-child {
      font-size: 16px;
    }

    /* é‚®ç®±æ˜¾ç¤º */
    .email-display {
      background: #f5f5f5;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
      font-size: 14px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>

<body>
  <div class="logo-title">
    <img src="../public/images/icons/favicon.png" alt="æˆç»©ç®¡ç†ç³»ç»Ÿ" class="logo">
    <h1>æˆç»©ç®¡ç†æ•™å­¦å¹³å°</h1>
  </div>

  <div class="reset-container">
    <div class="reset-header">
      <h2>ğŸ”‘ æ‰¾å›å¯†ç </h2>
      <p>é€šè¿‡ç»‘å®šçš„æ ¡å†…é‚®ç®±éªŒè¯èº«ä»½å¹¶é‡ç½®å¯†ç </p>
    </div>

    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="steps-indicator">
      <div class="step-dot active" id="step1Dot"></div>
      <div class="step-dot" id="step2Dot"></div>
      <div class="step-dot" id="step3Dot"></div>
    </div>

    <!-- æ­¥éª¤1: è¾“å…¥é‚®ç®± -->
    <div class="step-content active" id="step1">
      <div class="info-box">
        <span>ğŸ“§</span>
        <span>è¯·è¾“å…¥æ‚¨ç»‘å®šçš„æ ¡å†…é‚®ç®±åœ°å€</span>
      </div>
      <form id="step1Form">
        <div class="form-group">
          <label for="email">æ ¡å†…é‚®ç®±</label>
          <input type="email" id="email" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„æ ¡å†…é‚®ç®±" required>
          <div class="error-message" id="emailError">è¯¥é‚®ç®±æœªåœ¨ç³»ç»Ÿä¸­æ³¨å†Œï¼Œè¯·æ£€æŸ¥è¾“å…¥</div>
        </div>
        <button type="submit" class="submit-btn">ä¸‹ä¸€æ­¥</button>
      </form>
    </div>

    <!-- æ­¥éª¤2: éªŒè¯é‚®ç®± -->
    <div class="step-content" id="step2">
      <div class="email-display" id="emailDisplay">
        <span>ğŸ“§</span>
        <span id="displayEmail"></span>
      </div>
      <div class="info-box">
        <span>ğŸ’¡</span>
        <span>éªŒè¯ç å·²å‘é€è‡³æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶</span>
      </div>
      <form id="step2Form">
        <div class="form-group">
          <label for="verifyCode">éªŒè¯ç </label>
          <div class="code-input-group">
            <input type="text" id="verifyCode" class="form-control" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6" required>
            <button type="button" class="send-code-btn" id="resendBtn">é‡æ–°å‘é€</button>
          </div>
          <div class="error-message" id="codeError">éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</div>
        </div>
        <button type="submit" class="submit-btn">éªŒè¯</button>
      </form>
    </div>

    <!-- æ­¥éª¤3: é‡ç½®å¯†ç  -->
    <div class="step-content" id="step3">
      <form id="step3Form">
        <div class="form-group">
          <label for="newPassword">æ–°å¯†ç </label>
          <input type="password" id="newPassword" class="form-control" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>
          <div class="password-strength" id="strengthIndicator">
            <div class="strength-bar" id="bar1"></div>
            <div class="strength-bar" id="bar2"></div>
            <div class="strength-bar" id="bar3"></div>
          </div>
          <div class="strength-text" id="strengthText"></div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmPassword" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
          <div class="error-message" id="confirmError">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>
        </div>
        <button type="submit" class="submit-btn">é‡ç½®å¯†ç </button>
      </form>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div class="step-content" id="successStep">
      <div class="success-message">
        <div class="success-icon">âœ…</div>
        <h3>å¯†ç é‡ç½®æˆåŠŸï¼</h3>
        <p>æ‚¨çš„å¯†ç å·²æˆåŠŸé‡ç½®ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•</p>
        <a href="../index.html" class="submit-btn" style="display: inline-block; text-decoration: none;">è¿”å›ç™»å½•</a>
      </div>
    </div>

    <!-- è¿”å›ç™»å½•é“¾æ¥ -->
    <div class="back-link" id="backLink">
      <a href="../index.html">
        <span>â†</span>
        <span>è¿”å›ç™»å½•</span>
      </a>
    </div>
  </div>

  <script src="../js/utils.js"></script>
  <script src="../js/data/users.js"></script>
  <script>
    // å½“å‰æ­¥éª¤
    let currentStep = 1;
    let currentUser = null;
    let countdown = 0;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      initForms();
    });

    // åˆå§‹åŒ–è¡¨å•äº‹ä»¶
    function initForms() {
      // æ­¥éª¤1ï¼šéªŒè¯é‚®ç®±
      document.getElementById('step1Form').addEventListener('submit', function (e) {
        e.preventDefault();
        const email = document.getElementById('email').value.trim().toLowerCase();
        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('emailError');

        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
        emailInput.classList.remove('error');
        emailError.classList.remove('show');

        // åœ¨ UserData.users ä¸­æŸ¥æ‰¾é‚®ç®±
        const user = UserData.users.find(u => u.email && u.email.toLowerCase() === email && u.status === 'active');

        if (!user) {
          // é‚®ç®±ä¸å­˜åœ¨
          emailInput.classList.add('error');
          emailError.classList.add('show');
          return;
        }

        currentUser = user;

        // æ˜¾ç¤ºé‚®ç®±
        document.getElementById('displayEmail').textContent = email;

        // æ¨¡æ‹Ÿå‘é€éªŒè¯ç 
        sendVerificationCode();

        // è¿›å…¥æ­¥éª¤2
        goToStep(2);
      });

      // æ¸…é™¤è¾“å…¥æ—¶çš„é”™è¯¯çŠ¶æ€
      document.getElementById('email').addEventListener('input', function () {
        this.classList.remove('error');
        document.getElementById('emailError').classList.remove('show');
      });

      // æ­¥éª¤2ï¼šéªŒè¯é‚®ç®±éªŒè¯ç 
      document.getElementById('step2Form').addEventListener('submit', function (e) {
        e.preventDefault();
        const code = document.getElementById('verifyCode').value.trim();
        const codeInput = document.getElementById('verifyCode');
        const codeError = document.getElementById('codeError');

        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
        codeInput.classList.remove('error');
        codeError.classList.remove('show');

        // éªŒè¯ç éªŒè¯ï¼ˆæµ‹è¯•ç”¨ï¼š123456ï¼‰
        if (code !== '123456') {
          codeInput.classList.add('error');
          codeError.classList.add('show');
          return;
        }

        // éªŒè¯æˆåŠŸï¼Œè¿›å…¥æ­¥éª¤3
        goToStep(3);
      });

      // æ¸…é™¤éªŒè¯ç è¾“å…¥æ—¶çš„é”™è¯¯çŠ¶æ€
      document.getElementById('verifyCode').addEventListener('input', function () {
        this.classList.remove('error');
        document.getElementById('codeError').classList.remove('show');
      });

      // é‡æ–°å‘é€éªŒè¯ç 
      document.getElementById('resendBtn').addEventListener('click', function () {
        if (countdown > 0) return;
        sendVerificationCode();
      });

      // æ­¥éª¤3ï¼šé‡ç½®å¯†ç 
      document.getElementById('step3Form').addEventListener('submit', function (e) {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const confirmInput = document.getElementById('confirmPassword');
        const confirmError = document.getElementById('confirmError');

        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
        confirmInput.classList.remove('error');
        confirmError.classList.remove('show');

        if (newPassword.length < 6) {
          alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
          return;
        }

        if (newPassword !== confirmPassword) {
          confirmInput.classList.add('error');
          confirmError.classList.add('show');
          return;
        }

        // æ›´æ–°ç”¨æˆ·å¯†ç 
        if (currentUser) {
          UserData.userService.updateUser(currentUser.id, {
            password: newPassword
          });
        }

        // æ˜¾ç¤ºæˆåŠŸé¡µé¢
        goToStep(4);
      });

      // æ¸…é™¤ç¡®è®¤å¯†ç è¾“å…¥æ—¶çš„é”™è¯¯çŠ¶æ€
      document.getElementById('confirmPassword').addEventListener('input', function () {
        this.classList.remove('error');
        document.getElementById('confirmError').classList.remove('show');
      });

      // å¯†ç å¼ºåº¦æ£€æµ‹
      document.getElementById('newPassword').addEventListener('input', function () {
        checkPasswordStrength(this.value);
      });
    }

    // åˆ‡æ¢æ­¥éª¤
    function goToStep(step) {
      currentStep = step;

      // éšè—æ‰€æœ‰æ­¥éª¤
      document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));

      // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById('step' + i + 'Dot');
        dot.classList.remove('active', 'completed');
        if (i < step) {
          dot.classList.add('completed');
        } else if (i === step) {
          dot.classList.add('active');
        }
      }

      // æ˜¾ç¤ºå½“å‰æ­¥éª¤
      if (step === 4) {
        document.getElementById('successStep').classList.add('active');
        document.getElementById('backLink').style.display = 'none';
      } else {
        document.getElementById('step' + step).classList.add('active');
      }
    }

    // å‘é€éªŒè¯ç 
    function sendVerificationCode() {
      const btn = document.getElementById('resendBtn');
      countdown = 60;
      btn.disabled = true;

      const timer = setInterval(() => {
        countdown--;
        btn.textContent = countdown + 'såé‡å‘';

        if (countdown <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = 'é‡æ–°å‘é€';
        }
      }, 1000);

      // æ¨¡æ‹Ÿå‘é€éªŒè¯ç 
      console.log('éªŒè¯ç å·²å‘é€åˆ°:', currentUser?.email);
      alert('éªŒè¯ç å·²å‘é€ï¼ï¼ˆæµ‹è¯•ç”¨éªŒè¯ç ï¼š123456ï¼‰');
    }

    // æ£€æŸ¥å¯†ç å¼ºåº¦
    function checkPasswordStrength(password) {
      const bar1 = document.getElementById('bar1');
      const bar2 = document.getElementById('bar2');
      const bar3 = document.getElementById('bar3');
      const text = document.getElementById('strengthText');

      // é‡ç½®
      [bar1, bar2, bar3].forEach(bar => bar.className = 'strength-bar');

      if (!password) {
        text.textContent = '';
        return;
      }

      let strength = 0;
      if (password.length >= 6) strength++;
      if (password.length >= 8 && /[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password) && /[^a-zA-Z0-9]/.test(password)) strength++;

      if (strength >= 1) bar1.classList.add('weak');
      if (strength >= 2) {
        bar1.classList.remove('weak');
        bar1.classList.add('medium');
        bar2.classList.add('medium');
      }
      if (strength >= 3) {
        bar1.classList.remove('medium');
        bar2.classList.remove('medium');
        bar1.classList.add('strong');
        bar2.classList.add('strong');
        bar3.classList.add('strong');
      }

      const strengthLabels = ['', 'å¼±', 'ä¸­ç­‰', 'å¼º'];
      text.textContent = 'å¯†ç å¼ºåº¦ï¼š' + strengthLabels[strength];
    }
  </script>
</body>

</html>